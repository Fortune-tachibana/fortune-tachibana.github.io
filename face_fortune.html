<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="css/style.css"> <!-- â† çµ±ä¸€CSSã‚’èª­ã¿è¾¼ã¿ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>äººç›¸å ã„ | å ã„ã®é¤¨</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1873359578159316"
     crossorigin="anonymous"></script>
</head>
<body>

  <!-- èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
  <div id="clouds"></div>
  <canvas id="starCanvas"></canvas>

  <div class="container">
    <h1>äººç›¸å ã„</h1>
    <audio id="bgm" src="healing_music.mp3" loop></audio>
    <form id="fortune-form" class="form-section">
      <div class="input-group">
        <label for="lastName">LastName</label>
        <input type="text" id="lastName" required>
    
        <label for="firstName">FirstName</label>
        <input type="text" id="firstName" required>
    
        <label for="birthDate">BirthDay</label>
        <input type="date" id="birthDate" required>
    
        <label>FacePhoto</label>
        <input type="file" id="facePhoto" accept="image/*" required>
        <div id="facePreviewContainer" style="margin-top:10px;">
          <img id="previewFace" style="max-width: 300px; height: auto; display: none; border: 1px solid #ccc; padding: 5px; border-radius: 8px;">
        </div>
      </div>
    
      
      <!-- å ã†ãƒœã‚¿ãƒ³ -->
      <div class="submit-button-wrapper">
        <button type="submit">å ã†</button>
      </div>
    </form>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loadingScreen" style="display:none;">
      <div id="crystalBallWrapper">
        <canvas id="crystalBallCanvas"></canvas>
        <img id="starOverlay" src="images/star.png" alt="æ˜Ÿæ¨¡æ§˜" />
      </div>
      <p class="loading-text">æœªæ¥ã‚’è¦–ã¦ã„ã¾ã™â€¦</p>
    </div>

    <!-- çµæœã‚«ãƒ¼ãƒ‰ -->
    <div id="fortuneCard" class="card" style="display:none;">
      <div class="card-front">
        <p>ã‚ãªãŸã®é‹å‘½ã¯â€¦</p>
      </div>
      <div class="card-back">
        <p id="fortuneMessage">å ã„çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    </div>

    <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
    <canvas id="fortuneChart" width="300" height="300"></canvas>
    <p id="personalityMessage" class="personality-box" style="display: none;"></p>
    


    <!-- ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ  -->
    <p id="luckyItem"></p>

    <div id="testimonialBox" class="testimonial-box" style="display:none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <button id="saveImageBtn">çµæœã‚’ç”»åƒã¨ã—ã¦ä¿å­˜</button>

    <p id="fortuneRank"></p>


    <!-- ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
    <div id="share-buttons">
      <a id="twitter-share" href="#" target="_blank">Twitterã§ã‚·ã‚§ã‚¢</a>
      <a id="line-share" href="#" target="_blank">LINEã§ã‚·ã‚§ã‚¢</a>
    </div>

    <!-- è©³ç´°å ã„ãƒœã‚¿ãƒ³ -->
    <div class="details-button-container">
      <a href="https://lin.ee/YtBmRMl" target="_blank" class="details-button">ğŸ”® ç„¡æ–™ã§ã•ã‚‰ã«è©³ã—ãå ã†</a>
    </div>


    <!-- Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ç”¨ -->
    <form id="googleForm"
      action="https://docs.google.com/forms/d/e/1FAIpQLSf05PBSdvXsEY-aH2LaNduFnhUitO8BjYUZFwylRS8K8HeKpw/formResponse"
      method="POST"
      target="hidden_iframe"
      style="display:none;">
      <input type="hidden" name="entry.988363629" id="g-lastName">
      <input type="hidden" name="entry.2100239727" id="g-firstName">
      <input type="hidden" name="entry.2112033782" id="g-birthDate">
      <input type="hidden" name="entry.1713472671" id="g-deviceInfo">
    </form>
    <iframe name="hidden_iframe" style="display:none;"></iframe>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://inpncwavoxmbvtgqndsq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucG5jd2F2b3htYnZ0Z3FuZHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODg5NzMsImV4cCI6MjA3NDg2NDk3M30.VmdvTAmFno0hBy4NBZ03-6MUP8PnvHjyixGfkQqINyk';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    document.getElementById("fortune-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const lastName = document.getElementById("lastName").value.trim();
      const firstName = document.getElementById("firstName").value.trim();
      const birthDate = document.getElementById("birthDate").value;
      const file = document.getElementById("facePhoto").files[0];
      const fileName = `face_${Date.now()}.jpg`;

      if (file) {
        const { data, error } = await supabaseClient.storage
          .from('uploads')
          .upload(`faces/${fileName}`, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (error) {
          alert("å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          console.error(error);
          return;
        }
      }

      document.getElementById("g-lastName").value = lastName;
      document.getElementById("g-firstName").value = firstName;
      document.getElementById("g-birthDate").value = birthDate;
      document.getElementById("g-deviceInfo").value = navigator.userAgent;

      document.getElementById("googleForm").submit();

      const userData = `${lastName}-${firstName}-${birthDate}-${birthTime}-${navigator.userAgent}`;
      const seed = hashCode(userData);
      const ratings = generateRatings(seed);
      const message = generateMessage(seed);
      showChart(ratings);
      document.getElementById("fortuneMessage").innerText = message;
    });

    function hashCode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function generateRatings(seed) {
      const random = (n) => (Math.floor((Math.sin(seed++) * 10000) % 5) + 1);
      return ["é‡‘é‹", "æ‹æ„›é‹", "ä»•äº‹é‹", "å¥åº·é‹", "å…¨ä½“é‹"].map(() => random(seed));
    }

    function generateMessage(seed) {
      const messages = [
        "ä»Šæ—¥ã¯æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹ã®ã«æœ€é©ãªæ—¥ï¼",
        "ã¡ã‚‡ã£ã¨ä¼‘æ†©ãŒé‹æ°—ã‚¢ãƒƒãƒ—ã®ã‚«ã‚®ã€‚",
        "ç¬‘é¡”ãŒå¹¸é‹ã‚’å¼•ãå¯„ã›ã¾ã™ã€‚",
        "äººã¨ã®å‡ºä¼šã„ãŒãƒãƒ£ãƒ³ã‚¹ã‚’é‹ã³ã¾ã™ã€‚",
        "æ…é‡ã•ãŒåŠŸã‚’å¥ã™æ—¥ã§ã™ã€‚"
      ];
      return messages[seed % messages.length];
    }

    function showChart(data) {
      const ctx = document.getElementById('fortuneChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['é‡‘é‹', 'æ‹æ„›é‹', 'ä»•äº‹é‹', 'å¥åº·é‹', 'å…¨ä½“é‹'],
          datasets: [{
            label: 'å ã„çµæœ',
            data: data,
            backgroundColor: 'rgba(255, 255, 255, 0.2)',
            borderColor: '#fff',
            pointBackgroundColor: '#fff'
          }]
        },
        options: {
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 5,
              pointLabels: { color: '#fff' },
              grid: { color: '#aaa' },
              angleLines: { color: '#aaa' }
            }
          }
        }
      });
    }
  </script>
  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="js/main.js"></script>

</body>
</html>

